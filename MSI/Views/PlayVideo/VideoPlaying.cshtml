@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Scroll Viewer</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
        }

        .fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background-color: #000;
            overflow-y: auto;
        }

        #videoPlayer {
            display: none;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .error-card {
            background-color: #f8d7da;
            color: #721c24;
            padding: 250px;
            margin: 50px;
            border: 1px solid #f5c6cb;
            border-radius: .25rem;
            font-family: Arial, sans-serif;
            font-size: 40px;
            text-align: center;
        }

        #loading {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-top: 100px;
            color: #fff;
        }

        #htmlContent, #pdfContent {
            display: none;
            padding: 10px;
            color: white;
        }

        canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>

    @if (ViewBag.FileNotFound != null && ViewBag.FileNotFound == true)
    {
        <div class="error-card">
            <p>File not found!</p>
        </div>
        <div id="pageData" data-message="@ViewBag.FilePath"></div>
    }

    <div id="loading">Loading content...</div>

    <video id="videoPlayer" class="fullscreen" controls loop autoplay muted>
        Your browser does not support the video tag.
    </video>

    <div id="htmlContent" class="fullscreen"></div>

    <div id="pdfContent" class="fullscreen"></div>

</body>
</html>

<script>
    var scrollPaused = false;
    var scrollSpeed = 0.5; // pixels per frame
    var scrollElement = null;

    function enterFullscreen(element) {
        if (element.requestFullscreen) {
            element.requestFullscreen();
        } else if (element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen();
        } else if (element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
        } else if (element.msRequestFullscreen) {
            element.msRequestFullscreen();
        }
    }

    function startSmoothAutoScroll(el) {
        scrollElement = el;

        function scrollStep() {
            if (!scrollPaused && scrollElement) {
                scrollElement.scrollTop += scrollSpeed;

                if (scrollElement.scrollTop + scrollElement.clientHeight >= scrollElement.scrollHeight) {
                    scrollElement.scrollTop = 0; // Loop to top
                }
            }

            requestAnimationFrame(scrollStep);
        }

        requestAnimationFrame(scrollStep);
    }

    $(document).ready(function () {
        var path = '@ViewBag.FilePath'.trim();
        var fileType = path.split('.').pop().toLowerCase();
        var videoElement = $("#videoPlayer");

        if (fileType === 'mp4') {
            var videoSrc = "/videos/" + path;
            videoElement.attr("src", videoSrc);
            videoElement.on("canplay", function () {
                $("#loading").hide();
                videoElement.show();
                enterFullscreen(videoElement[0]);
            });
            videoElement.on("error", function () {
                $("#loading").text("Failed to load video.");
            });

        } else if (fileType === 'html') {
            var htmlContainer = $("#htmlContent");
            $("#loading").hide();

            $.ajax({
                url: "/videos/" + path,
                success: function (data) {
                    htmlContainer.html(data);
                    htmlContainer.show();
                    enterFullscreen(htmlContainer[0]);
                    startSmoothAutoScroll(htmlContainer[0]);
                },
                error: function () {
                    $("#loading").text("Failed to load HTML file.");
                }
            });

        } else if (fileType === 'pdf') {
            var pdfContainer = document.getElementById("pdfContent");
            var pdfSrc = "/videos/" + path;
            $("#loading").hide();

            var loadingTask = pdfjsLib.getDocument(pdfSrc);
            loadingTask.promise.then(function (pdfDoc_) {
                var pdfDoc = pdfDoc_;

                function renderPage(pageNum) {
                    pdfDoc.getPage(pageNum).then(function (page) {
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');

                        var unscaledViewport = page.getViewport({ scale: 1 });
                        var containerWidth = pdfContainer.clientWidth;
                        var scale = containerWidth / unscaledViewport.width;
                        var viewport = page.getViewport({ scale: scale });

                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        var renderContext = {
                            canvasContext: ctx,
                            viewport: viewport
                        };

                        page.render(renderContext).promise.then(function () {
                            pdfContainer.appendChild(canvas);
                        });
                    });
                }

                for (let page = 1; page <= pdfDoc.numPages; page++) {
                    renderPage(page);
                }

                pdfContainer.style.display = "block";
                enterFullscreen(pdfContainer);
                startSmoothAutoScroll(pdfContainer);
            });

        } else {
            $("#loading").text("Invalid file type.");
        }

        // Click toggles scroll pause/resume
        $('body').on('click', function () {
            scrollPaused = !scrollPaused;
        });
    });
</script>
